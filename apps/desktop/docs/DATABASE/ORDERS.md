## 6. Pedidos (Orders)

Para tornar a tabela `orders` verdadeiramente **generalista**, ela precisa funcionar como um **documento legal imutável**.

Diferente do carrinho (`checkout`), que é rascunho, ou do produto, que muda de preço, o Pedido é uma fotografia de um momento no tempo. Se você vender uma consultoria, um carro ou um ebook, a estrutura do pedido deve ser agnóstica ao item.

Aqui estão os atributos generalistas essenciais explicados a fundo:

---

### 1. A Trindade de Status (Desacoplamento)

Sistemas amadores usam apenas um campo `status` (Ex: Pendente, Pago, Enviado). Isso falha no mundo real.
Para ser generalista, você precisa separar o progresso do pedido em três eixos independentes:

- **`status` (Ciclo de Vida do Contrato):**
- Define se o pedido está "vivo".
- Ex: `open` (ativo), `archived` (antigo), `cancelled` (morto).

- **`payment_status` (Fluxo Financeiro):**
- Ex: `unpaid`, `partially_paid` (pagou metade no Pix, falta o resto), `paid`, `refunded`, `partially_refunded`.
- _Cenário:_ Um restaurante (Paga DEPOIS de consumir) vs E-commerce (Paga ANTES de enviar).

- **`fulfillment_status` (Fluxo Logístico/Entrega):**
- Ex: `unfulfilled`, `scheduled` (serviços agendados), `partially_fulfilled` (enviou só metade), `fulfilled`, `returned`.
- _Cenário:_ Você pode ter um pedido `paid` mas `unfulfilled` (Pré-venda). Ou um pedido `fulfilled` mas `unpaid` (Venda faturada para empresa/Boleto a prazo).

### 2. Identidade e Origem (`channel` & `tags`)

Como o pedido pode vir de qualquer lugar, você precisa saber a fonte para relatórios e regras de negócio.

- **`channel` (String):**
- Identifica a porta de entrada.
- Exemplos: `web_store`, `mobile_app`, `pos_store_01` (Caixa físico), `whatsapp_bot`, `amazon_marketplace`.

- **`tags` (Array/JSONB):**
- O sistema de etiquetagem flexível para operação.
- Exemplos: `["vip_customer", "suspected_fraud", "urgent_delivery", "black_friday"]`.
- Isso permite que o time de logística filtre: "Me dê todos os pedidos com tag `urgent`".

### 3. O Snapshot Financeiro (Imutabilidade)

O pedido **não pode** depender de cálculos dinâmicos. Todos os valores devem ser salvos como valores fixos (Hardcoded) no momento da criação.

- **`currency` (String):** BRL, USD. O pedido nasce e morre na moeda original.
- **`tax_lines` (JSONB):**
- Em vez de apenas um total, guarde o detalhe fiscal.
- Ex: `[{"title": "ICMS", "rate": 0.18, "amount": 18.00}, {"title": "IPI", "rate": 0.05, "amount": 5.00}]`.
- Isso serve para qualquer país e qualquer regime tributário.

- **`discount_applications` (JSONB):**
- Rastreabilidade de _por que_ o preço baixou.
- Ex: `[{"code": "NATAL10", "amount": 10.00, "type": "percentage"}, {"description": "Desconto Gerente", "amount": 50.00}]`.

### 4. Campos de "Extensibilidade" (A Mágica do JSONB)

Aqui é onde você resolve o problema de "produtos estranhos" ou "regras B2B" sem criar colunas novas.

- **`custom_attributes` (JSONB):**
- Dados que o **cliente** preencheu e são visíveis para ele.
- _Floricultura:_ `{"key": "Mensagem Cartão", "value": "Te amo mãe"}`.
- _B2B:_ `{"key": "Número da PO", "value": "PO-998877"}`.
- _Delivery:_ `{"key": "Instrução", "value": "Tocar interfone 2x"}`.

- **`metadata` (JSONB):**
- Dados ocultos do sistema/backend (não visíveis ao cliente).
- _Integração:_ `{"erp_order_id": "999", "sync_status": "success"}`.
- _Marketing:_ `{"utm_source": "google", "utm_campaign": "verao2026"}`.

- **`risk_analysis` (JSONB):**
- Dados de fraude consolidados.
- Ex: `{"score": 85, "recommendation": "review", "provider": "clearsale"}`.

### 5. Snapshot do Cliente (`customer_snapshot`)

Este é um erro clássico: Relacionar o Pedido ao Cliente apenas por ID (`customer_id`).
**O Problema:** Se o cliente mudar o e-mail ou o telefone amanhã, o histórico do pedido antigo muda incorretamente. Ou se o usuário for deletado (LGPD), o pedido quebra.

**A Solução Generalista:**

- **`customer_snapshot` (JSONB):**
- Cópia dos dados do cliente _no momento da compra_.
- `{"name": "João", "email": "joao@email.com", "phone": "1199999999", "tax_id": "CPF..."}`.
- Isso garante a integridade da nota fiscal para sempre.

---

### Exemplo de SQL (PostgreSQL)

Aqui está a implementação técnica desses conceitos:

```sql
CREATE TABLE orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- Identificadores
    order_number BIGINT GENERATED BY DEFAULT AS IDENTITY, -- Sequencial simples para humanos (#1001)
    idempotency_key VARCHAR(100) UNIQUE, -- Previne duplicação técnica (clique duplo no botão comprar)
    channel VARCHAR(50) DEFAULT 'web', -- De onde veio

    -- Relacionamentos
    shop_id UUID, -- Para sistemas Multi-tenant/Marketplace
    customer_id UUID, -- Link "vivo" (pode ser null se Guest)

    -- Máquina de Estados (O Triângulo de Status)
    status VARCHAR(20) DEFAULT 'open', -- open, archived, cancelled
    payment_status VARCHAR(20) DEFAULT 'unpaid', -- unpaid, authorized, paid, refunded, voided
    fulfillment_status VARCHAR(20) DEFAULT 'unfulfilled', -- unfulfilled, partial, fulfilled, restocked

    -- O Dinheiro (Snapshot Imutável)
    currency CHAR(3) DEFAULT 'BRL',
    subtotal_price DECIMAL(15, 2) NOT NULL, -- Soma dos itens
    total_discounts DECIMAL(15, 2) DEFAULT 0,
    total_tax DECIMAL(15, 2) DEFAULT 0,
    total_shipping DECIMAL(15, 2) DEFAULT 0,
    total_tip DECIMAL(15, 2) DEFAULT 0, -- Gorjeta (Comum em Food Service)
    total_price DECIMAL(15, 2) NOT NULL, -- O valor que saiu do bolso do cliente

    -- Dados Ricos (JSONB)
    tax_lines JSONB DEFAULT '[]', -- Detalhe dos impostos
    discount_codes JSONB DEFAULT '[]', -- Cupons usados

    -- Extensibilidade
    note TEXT, -- Campo simples de observação
    tags TEXT[], -- Array de strings para filtros rápidos
    custom_attributes JSONB DEFAULT '[]', -- Campos extras do cliente (KV Pair)
    metadata JSONB DEFAULT '{}', -- Campos técnicos ocultos

    -- Snapshots de Segurança
    customer_snapshot JSONB NOT NULL, -- Dados do cliente congelados
    billing_address JSONB, -- Endereço fiscal congelado
    shipping_address JSONB, -- Endereço entrega congelado

    -- Rastreabilidade Temporal
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    cancelled_at TIMESTAMP,
    closed_at TIMESTAMP -- Quando o pedido foi arquivado
);

```

### Resumo da Generalização

Essa estrutura suporta:

1. **Venda de Carro:** `fulfillment_status` vira "Aguardando Retirada", `metadata` guarda o número do Chassi.
2. **Assinatura de Software:** `shipping_address` é nulo, `fulfillment_status` vira "Fulfilled" automaticamente ao enviar o e-mail de ativação.
3. **Pizza:** `custom_attributes` guarda "Sem cebola", `total_tip` guarda a gorjeta do motoboy.
4. ## **B2B Industrial:** `payment_status` fica `unpaid` (Faturado 30 dias), `metadata` guarda código de aprovação do gerente.
